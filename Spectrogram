2. Spectrogram

import numpy as np                          # 수치 계산 및 배열 처리용
import matplotlib.pyplot as plt             # 스펙트로그램 시각화용
import pydub                                # 오디오 파일 로드 및 분할용
from scipy.fftpack import fft               # FFT(고속 푸리에 변환) 함수

# ===== m4a 파일 로드 설정 =====
pydub.AudioSegment.converter = "C:/ffmpeg/bin/ffmpeg.exe"
                                           # pydub이 내부적으로 사용할 ffmpeg 실행 파일 경로 지정

sound = pydub.AudioSegment.from_file(
    "C:/Users/user/OneDrive/바탕 화면/동의대/팀플/캡스톤디자인/캡스톤디자인 I/정수기 음원/주파수 분석/cylinder/Cylinder_3-8_4cm.m4a",
    format="m4a"
)
                                           # m4a 오디오 파일을 AudioSegment 객체로 로드

# ===== 샘플링 주파수 =====
sample_rate = sound.frame_rate             # 오디오 샘플링 주파수(fs), 예: 44100 Hz

# ===== chunk_size 설정 =====
chunk_size = int(sample_rate * 5 / len(sound))
                                           # 오디오 전체 길이(len(sound)는 ms 단위)에 비례한 chunk 크기
                                           # 시간 해상도를 맞추기 위한 경험적 설정
                                           # ⚠ 물리적으로 직관적인 값(20ms 등)은 아님

# ===== FFT 파라미터 =====
nfft = 512                                 # FFT 포인트 수 (zero-padding 포함)

spectrogram = []                           # 시간별 FFT 결과를 저장할 리스트

# ===== chunk 단위로 FFT 계산 =====
for i in range(0, len(sound), chunk_size): # 전체 오디오를 chunk_size(ms) 간격으로 순회
    
    chunk = sound[i:i+chunk_size]          # i번째 시간 구간의 오디오 조각 추출
    
    samples = chunk.get_array_of_samples() # AudioSegment → PCM 샘플 배열(int16 등)
    
    Zxx = fft(samples, n=nfft)             # FFT 수행 (nfft 길이로 zero-padding 포함)
    
    Zxx = 20 * np.log10(np.abs(Zxx) + 1e-6) * 4
                                           # FFT 복소값 → 크기(abs)
                                           # log10으로 dB 스케일 변환
                                           # 1e-6: log(0) 방지
                                           # *4: 시각적 대비를 키우기 위한 임의 스케일
    
    spectrogram.append(Zxx.reshape(-1, 1)) # FFT 결과를 세로 벡터 형태로 저장
                                           # 시간축 방향으로 이어붙이기 위함

# ===== 스펙트로그램 이어붙이기 =====
full_spectrogram = np.concatenate(spectrogram, axis=1)
                                           # [주파수 × 시간] 형태의 2차원 배열 생성

# ===== 관심 주파수 대역 선택 =====
freq_min = 0                               # 최소 주파수(Hz)
freq_max = 8000                            # 최대 주파수(Hz)

freq_min_index = int(freq_min / (sample_rate / 2) * (nfft // 2))
                                           # freq_min(Hz)을 FFT 인덱스로 변환

freq_max_index = int(freq_max / (sample_rate / 2) * (nfft // 2))
                                           # freq_max(Hz)을 FFT 인덱스로 변환

selected_spectrogram = full_spectrogram[
    freq_min_index:freq_max_index
]
                                           # 관심 주파수 대역만 슬라이싱

# ===== 스펙트로그램 시각화 =====
plt.figure(figsize=(10, 6))                # 그래프 크기 설정

plt.imshow(
    selected_spectrogram,                 # 표시할 스펙트로그램 데이터
    aspect='auto',                        # 시간/주파수 비율 자동 조정
    cmap='inferno',                       # 색상 맵(에너지 강조에 적합)
    extent=[0, len(sound) / 1000,          # x축: 시간 (ms → s 변환)
            freq_min, freq_max],           # y축: 주파수 (Hz)
    origin='lower'                         # 저주파가 아래쪽에 오도록 설정
)

plt.xlabel('Time (s)')                     # x축 라벨
plt.ylabel('Frequency (Hz)')               # y축 라벨
plt.title('Mess_cylinder_FFT_Spectrogram') # 그래프 제목

plt.colorbar(label='Intensity (dB)')       # 색상바(에너지 크기)

plt.show()                                 # 스펙트로그램 출력
